---
title: "UMBS LTREB Coarse Woody Debris Table Cleaning"
author: "Alexandria Pawlik"
output: html_notebook
---

Required packages and paths
```{r}
library(tidyverse)
library(lubridate)
library(dplyr)
library(xlsx)
library(tibble)
library(dataMaid)
options(stringsAsFactors = FALSE)

# set these paths for your machine's specifics
cwd_path_2014 <- "../raw/CWD_2014_raw.csv"
cwd_path_2019 <- "../raw/CWD_2019_raw.csv"
output_path <- "../output/cwd.csv"

# output site IDs
plots_path <- "../plots/cwd_plots.csv"
```

*2014 data cleaning by Alina Drebin*

Read in 2014 data
```{r}
cwd_data <- read_csv(cwd_path_2014)
species <- sort(unique(cwd_data$`Species code (if possible)`))

# remove row with only NA
cwd_data <- cwd_data %>% 
  filter_all(any_vars(!is.na(.)))
```

Fix column names to conform to EDI standards
```{r}
cwd_data <- cwd_data %>% 
  rename(Stand_Name = `Stand name`) %>% 
  rename(Date = `Date Sampled`) %>% 
  rename(Plot_ID = `Plot ID`) %>% 
  rename(CWD_Subplot_ID = `CWD subplot ID`) %>% 
  rename(Species = `Species code (if possible)`) %>% 
  rename(Length = `Length (m)`) %>% 
  rename(Endpoint_1_Diameter = `Endpoint 1 diameter (cm)`) %>% 
  rename(Midpoint_Diameter = `Midpoint diameter (cm)`) %>% 
  rename(Endpoint_2_Diamteter = `Endpoint 2 diameter (cm)`) %>% 
  rename(Decay_Class_Whole_Piece = `Decay class of whole piece`) %>% 
  rename(Avg_Diameter = `Avg. Diameter (cm)`) %>% 
  rename(Avg_Radius = `Avg. Radius (cm)`) %>% 
  rename(Avg_Area = `Avg. Area (cm^2)`) %>% 
  rename(Estimated_Volume_Tapered = `Est. Tapered Volume (cm^3)`) %>% 
  rename(Estimated_Biomass_Tapered = `Estimated Biomass (taper) (g)`)
```

Create status column to represent if stump or not, and take out of species code column
```{r}
cwd_data <- cwd_data %>% 
  mutate(Status = ifelse(str_sub(Species, 1, 8)=="Stump - ", "Stump", NA))

cwd_data <- cwd_data %>% 
  mutate(Species = ifelse(str_sub(Species, 1, 8)=="Stump - ", str_sub(Species, 9, -1), Species))

cwd_data$Status[cwd_data$Species == "Stump Piece - PIST"] <- "Stump Piece"
cwd_data$Species[cwd_data$Species == "Stump Piece - PIST"] <- "PIST"

species <- sort(unique(cwd_data$Species))
```

Remove stump from species code + decay class column
```{r}
concat <- sort(unique(cwd_data$Species))

cwd_data <- cwd_data %>% 
  mutate(`Species Code + Decay Class` = ifelse(str_sub(`Species Code + Decay Class`, 1, 8)=="Stump - ", str_sub(`Species Code + Decay Class`, 9, -1), `Species Code + Decay Class`))

cwd_data$`Species Code + Decay Class`[cwd_data$`Species Code + Decay Class` == "Stump Piece - PIST2"] <- "PIST2"

concat <- sort(unique(cwd_data$`Species Code + Decay Class`))
```

Convert date to standard format
```{r}
cwd_data$Date <- mdy(cwd_data$Date)
```

Reorganize columns
```{r}
cwd_data <- cwd_data %>% select(1:3,5,6, 19, 7:14, 16:18)
```

Fix biomasses
```{r}
# change all 0 biomasses to NA when volume isn't 0
cwd_data$Estimated_Biomass_Tapered[cwd_data$Estimated_Biomass_Tapered == 0] <- NA

# remove missing values
cwd_data$Estimated_Volume_Tapered[cwd_data$Estimated_Volume_Tapered == "#VALUE!"] <- NA
cwd_data$Estimated_Biomass_Tapered[cwd_data$Estimated_Biomass_Tapered == "#VALUE!"] <- NA
```

Fix species names, change ? to NA
```{r}
cwd_data <- cwd_data %>%  
  mutate(Species = ifelse(str_sub(Species, 1, 1) == "?", NA, Species))
```

Fix plot names to match AGB
```{r}
plot_names <- unique(data.frame(cwd_data$Stand_Name, cwd_data$Plot_ID))

cwd_data <- cwd_data %>% 
  add_column(Plot = NA, .before = 1)
cwd_data$Plot = cwd_data$Plot_ID
cwd_data$Plot_ID <- as.character(cwd_data$Plot_ID)

cwd_data$Plot[cwd_data$Plot_ID == "1"] <- "DNR1"
cwd_data$Plot[cwd_data$Plot_ID == "2"] <- "DNR2"
cwd_data$Plot[cwd_data$Plot_ID == "3"] <- "DNR3"
cwd_data$Plot[cwd_data$Plot_ID == "CP#1"] <- "CP1"
cwd_data$Plot[cwd_data$Plot_ID == "CP#2"] <- "CP2"
cwd_data$Plot[cwd_data$Plot_ID == "CP#3"] <- "CP3"
cwd_data$Plot[cwd_data$Plot_ID == "PSA1972#1"] <- "PSA1"
cwd_data$Plot[cwd_data$Plot_ID == "PSA1972#2"] <- "PSA2"
cwd_data$Plot[cwd_data$Plot_ID == "PSA1972#3"] <- "PSA3"
cwd_data$Plot[cwd_data$Plot_ID == "BF1"] <- "BP54#1"
cwd_data$Plot[cwd_data$Plot_ID == "BF2"] <- "BP54#2"

us <- unique(cwd_data$Plot)

cwd_data <- cwd_data %>% 
  select(1, 3, 5:18) %>% 
  rename(Estimated_Mass_Tapered = Estimated_Biomass_Tapered) %>% 
  rename(Plot_ID = Plot)
```

Fix column types
```{r}
cwd_14 <- cwd_data %>% 
  mutate(Length = as.numeric(Length)) %>% 
  mutate(Estimated_Volume_Tapered = as.numeric(Estimated_Volume_Tapered)) %>% 
  mutate(Estimated_Mass_Tapered = as.numeric(Estimated_Mass_Tapered))

# output just 2014 data here
```

*2019 data cleaning by Alexandria Pawlik*

Pull in 2019 data and add date column
```{r}
# cwd_19 <- read_csv(cwd_path_2019)
```

Write csv file
```{r}
# write_csv(cwd_data, path = output_path)

# output plot list
# plots <- unique(cwd_14$Plot_ID)
# write.csv(plots, file = plots_path, row.names = FALSE)
```


